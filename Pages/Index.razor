@page "/"
@using System.Collections.Generic;
@using HomeApp.Data.Radarr;
@using HomeApp.Models.Domain.Movies;
@using System.Dynamic;
@inject RadarrMovieLibraryService Radarr;

<PageTitle>Dashboard</PageTitle>

@* <MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudGrid>
        <MudItem xs="12" sm="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Radarr</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="movies" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
                        LoadingProgressColor="Color.Info">
                        <HeaderContent>
                            <MudTh>Poster</MudTh>
                            <MudTh>Title</MudTh>
                            <MudTh>Year</MudTh>
                            <MudTh>Genres</MudTh>
                            <MudTh>Quality</MudTh>
                            <MudTh>Status</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Poster"><img src="@GetPosterUrl(context)" style="width:100px; height: auto;" /></MudTd>
                            <MudTd DataLabel="Title">
                                <div><b>@context.Title</b></div>
                                <div>@LimitOverview(context.Overview)</div>
                            </MudTd>
                            <MudTd DataLabel="Year">@context.Year</MudTd>
                            <MudTd DataLabel="Genres">@string.Join(", ", context.Genres)</MudTd>
                            <MudTd DataLabel="Quality">@context.MovieFile?.Quality.Quality?.Name</MudTd>
                            <MudTd DataLabel="Status">@CalculateStatus(context)</MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager />
                        </PagerContent>
                    </MudTable>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="OnGetLibraryClicked">Read More
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="12" md="6">

            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Sonarr</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText>This day everything happend.</MudText>
                    <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary">Read More</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="12" md="4">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Plex</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText>This day everything happend.</MudText>
                    <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary">Read More</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudGrid>
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-4" Style="height: 200px;"></MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-4" Style="height: 200px;"></MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%"></MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 200px;"></MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 200px;"></MudPaper>
        </MudItem>
        <MudItem xs="12" sm="12" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 200px;"></MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer> *@

@code {
    List<Movie> movies = new List<Movie>();
    private bool _hidePosition;
    private bool _loading;
    private void OnGetLibraryClicked(object sender)
    {
        Console.WriteLine("Clicked");
    }

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        Radarr.GetLibrary().ContinueWith(response => {
            movies = response.Result;
            _loading = false;
        });
    }

    private string GetPosterUrl (Movie movie) {
        return movie.Images.FirstOrDefault(image => image.CoverType == "poster")?.RemoteUrl;
    }

    private string LimitOverview(string overview) {
        if(string.IsNullOrWhiteSpace(overview)) 
            return "";

        if(overview.Length > 200){
            return overview.Substring(0, 200) + "...";
        }
        else return overview;
    }

    private string CalculateStatus(Movie movie){
        string status = "";

        if(movie.Status == "released") {
            if(movie.HasFile) {
                status = "Downloaded";
            }
            else if(movie.IsAvailable) {
                status = "Downloadable";
            }
        } else {
           status = "Unavailable";
        }


        return status;
    }

}